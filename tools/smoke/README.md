# Smoke compare (pre-refactor vs refactor)

These scripts compare output files generated by a **pre-refactor (legacy)** module vs the **refactored (composer-lib)** implementation, against the **same FrontAccounting database**.

Why two scripts?
- `compare.php` runs `generate.php` twice in **separate PHP processes** so two different module trees can be tested without class-name collisions.

## Requirements

- Run inside a FrontAccounting environment where `db_query`, `db_fetch`, and `TB_PREF` are available.
- The module trees must be available as two folders:
  - **Legacy module folder** (your production / pre-refactor code)
  - **Refactor module folder** (this code)

## Typical usage (recommended: staging)

From your FrontAccounting root (or anywhere, as long as you pass `--fa-root`):

```bash
php modules/ksf_generate_catalogue/tools/smoke/compare.php \
  --fa-root=/var/www/frontaccounting \
  --legacy-module=/var/www/frontaccounting/modules/ksf_generate_catalogue_pre_refactor \
  --refactor-module=/var/www/frontaccounting/modules/ksf_generate_catalogue \
  --prefs-table=ksf_prefs \
  --out-dir=/tmp
```

By default it compares: `pricebook,square,woocommerce`.

### Choose generators

```bash
php modules/ksf_generate_catalogue/tools/smoke/compare.php \
  --fa-root=/var/www/frontaccounting \
  --legacy-module=... \
  --refactor-module=... \
  --prefs-table=ksf_prefs \
  --out-dir=/tmp \
  --generators=pricebook,square,woocommerce,labels
```

### Keep artifacts

```bash
php modules/ksf_generate_catalogue/tools/smoke/compare.php ... --keep-files=1
```

Artifacts are written under `--out-dir/smoke_YYYYmmdd_HHMMSS/` and include `report.json`.

## Notes / gotchas

- Some outputs are expected to differ if new columns or formats were intentionally added (e.g., Woo `Type`/`Parent`). The report will show the first differing line to speed up review.
- Refactored generators rely on a Composer autoloader; `generate.php` searches common locations. If needed, pass `--autoload=/path/to/vendor/autoload.php` to `generate.php`.
